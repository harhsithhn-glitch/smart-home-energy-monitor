<!DOCTYPE html>
<html>
<head>
    <title>Smart Home Energy Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>

<h1>‚ö° Smart Home Energy Dashboard</h1>

<button class="theme-btn" onclick="toggleTheme()">Toggle Theme</button>
<a href="/export"><button class="theme-btn">Export CSV</button></a>

<div class="card main-card">
    <h2>House Power</h2>
    <div class="big-number">
        <span id="power">0</span> W
    </div>
    <p>Predicted Next: <b><span id="predicted">0</span> W</b></p>
    <div class="status" id="status">NORMAL</div>
</div>

<!-- DEVICE BREAKDOWN -->
<h2>üè† Device Breakdown</h2>
<div class="analytics">
    <div class="a-card blue">Fan <h3><span id="fan">0</span> W</h3></div>
    <div class="a-card green">AC <h3><span id="ac">0</span> W</h3></div>
    <div class="a-card purple">TV <h3><span id="tv">0</span> W</h3></div>
    <div class="a-card blue">Fridge <h3><span id="fridge">0</span> W</h3></div>
</div>

<!-- ANALYTICS -->
<h2>üìä Analytics</h2>
<div class="analytics">
    <div class="a-card blue">
        Daily Energy
        <h3><span id="dailyEnergy">0</span> kWh</h3>
    </div>
    <div class="a-card green">
        Today‚Äôs Bill
        <h3>‚Çπ <span id="dailyCost">0</span></h3>
    </div>
    <div class="a-card purple">
        Monthly Estimate
        <h3>‚Çπ <span id="monthlyCost">0</span></h3>
    </div>
</div>

<h2>üìà Live Power Usage</h2>
<canvas id="chart"></canvas>

<h2>üìã Recent Records</h2>
<table>
    <thead>
        <tr>
            <th>Time</th>
            <th>Power (W)</th>
            <th>Energy (kWh)</th>
            <th>Cost (‚Çπ)</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
let labels = [], actual = [];

const chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
        labels,
        datasets: [{
            label: "Power (W)",
            data: actual,
            borderColor: "#00ffcc",
            backgroundColor: "rgba(0,255,204,0.2)",
            tension: 0.4,
            fill: true
        }]
    },
    options: { responsive: true, animation: false }
});

function updateData(){
    fetch("/data")
    .then(r=>r.json())
    .then(d=>{

        power.innerText = d.current.total;
        predicted.innerText = d.current.predicted;

        fan.innerText = d.current.fan;
        ac.innerText = d.current.ac;
        tv.innerText = d.current.tv;
        fridge.innerText = d.current.fridge;

        dailyEnergy.innerText = d.analytics.daily_energy;
        dailyCost.innerText = d.analytics.daily_cost;
        monthlyCost.innerText = d.analytics.monthly_cost;

        let s = "NORMAL";
        status.className = "status normal";

        if(d.current.total > 2500){
            s="CRITICAL";
            status.className="status critical";
        }
        else if(d.current.total > 1500){
            s="HIGH";
            status.className="status high";
        }

        status.innerText = s;

        labels.push(d.current.time);
        actual.push(d.current.total);

        if(labels.length>10){
            labels.shift();
            actual.shift();
        }

        chart.update();

        tableBody.innerHTML = d.history.slice().reverse().map(r=>`
            <tr>
                <td>${r.time}</td>
                <td>${r.total}</td>
                <td>${r.energy}</td>
                <td>${r.cost}</td>
            </tr>
        `).join("");
    });
}

setInterval(updateData,2000);
updateData();

function toggleTheme(){
    document.body.classList.toggle("light");
}
</script>

</body>
</html>